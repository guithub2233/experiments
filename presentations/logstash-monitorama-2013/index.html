<!-- header crap {{{ -->
<!-- TODO 
  * Kibana stuff?
  * Live demo slot?
  * Horrible log examples for transitions
  -->
<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>logstash - overview</title>

    <meta name="description" content="logstash">
    <meta name="author" content="Jordan SIssel">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="css/reveal.min.css">
    <link rel="stylesheet" href="css/theme/night-jls.css" id="theme">

    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- If the query includes 'print-pdf', use the PDF print sheet -->
    <script>
      document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="css/extra.css">
  </head>

  <body>

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">

<!-- }}} -->

        <section> 
          <img src="images/logstash.png" class="plain full left">
          <div class="right">
            <h2 class="bold">logstash</h2>
            <hr>
            <h4 style="text-align: right"> Jordan Sissel </h4>
            <h4 style="text-align: right"> logger @ DreamHost </h4>
          </div>
        </section> 

        <!-- first principles  (2 slides) {{{ -->
        <section data-markdown>
          first principles
        </section>

        <section>
          <p class="text-left">first principles</p><hr>

          <h2 class="text-right">
            If a newbie has a bad time,<br>
          </h2>
          <h1 class="text-right"> it is a bug.</h1>
        </section>

        <section>
          <h2> agenda: logstash ops </h2>

          <ul>
            <li> scaling logstash
            <li> logstash 
            <li> elasticsearch tunables
            <li> java tunables
          </ul>
        </section>
        <!-- }}} -->

        <!-- Case Study: DreamHost (2 slides) {{{ -->
        <section>
          <h3 class="text-left"> logs @ DreamHost </h3>
          <img src="images/Dreamhost_logo.svg" class="left plain">
          <ul style="margin-top:1em;">
            <li> Want customers to be happy!
            <li> Want employees to be happy!
            <li> Hundreds of servers
            <li> Many different products
            <li> Thousands of log sources
            <li> Billions of events per day
          </ul>
        </section>
        <!-- end dreamhost stuff }}} -->

        <!-- logstash / scaling {{{ -->
        <section>
          <img src="images/logstash.png" class="full plain">
        </section>

        <section>
          <img src="images/simple-inputs-filters-outputs.jpg" class="full plain">
        </section> 

        <section data-markdown>
          ## scale out?

          * transport: many messaging technologies
          * processing: logstash | logstash | logstash ...
          * storage: elasticsearch scales horizontally
        </section>

        <section>
          <img src="images/tiered-outputs-to-inputs.jpg" class="full plain">
        </section>
        <!-- }}} -->

        <!-- example scaled deploy {{{ -->
        <section>
          <h3> example  </h3>
          <span class="left">
            <img src="images/apache-icon.gif" style="height: 2em" class="block">
            <img src="images/apache-icon.gif" style="height: 2em" class="block">
            <img src="images/apache-icon.gif" style="height: 2em" class="block">
            <img src="images/apache-icon.gif" style="height: 2em" class="block">
            <img src="images/apache-icon.gif" style="height: 2em" class="block">
          </span>
          <span style="font-size: 2em;" class="left"> <div>→</div> <div>→</div> <div>→</div> <div>→</div> </span>
          <span class="left">
            <img src="images/logstash.png" class="plain block" style="width: 3em">
            <img src="images/logstash.png" class="plain block" style="width: 3em">
          </span>
          <span style="font-size: 2em;" class="left"> <div>→</div> <div>→</div> <div>→</div> <div>→</div> </span>
          <span class="left">
            <img src="images/redis.png" class="plain block" style="width: 3em">
            <img src="images/redis.png" class="plain block" style="width: 3em">
            <img src="images/redis.png" class="plain block" style="width: 3em">
          </span>
          <span style="font-size: 2em;" class="left"> <div>→</div> <div>→</div> <div>→</div> <div>→</div> </span>
          <span class="left">
            <img src="images/logstash.png" class="plain block" style="width: 2em">
            <img src="images/logstash.png" class="plain block" style="width: 2em">
            <img src="images/logstash.png" class="plain block" style="width: 2em">
            <img src="images/logstash.png" class="plain block" style="width: 2em">
          </span>
          <span style="font-size: 2em;" class="left"> <div>→</div> <div>→</div> <div>→</div> <div>→</div> </span>
          <span class="left">
            <img src="images/elasticsearch.png" class="plain block" style="width: 3em">
            <img src="images/elasticsearch.png" class="plain block" style="width: 3em">
            <img src="images/elasticsearch.png" class="plain block" style="width: 3em">
            <img src="images/elasticsearch.png" class="plain block" style="width: 3em">
            <img src="images/elasticsearch.png" class="plain block" style="width: 3em">
          </span>
          <span class="left">
            <img src="images/elasticsearch.png" class="plain block" style="width: 2em">
            <img src="images/elasticsearch.png" class="plain block" style="width: 2em">
            <img src="images/elasticsearch.png" class="plain block" style="width: 2em">
            <img src="images/elasticsearch.png" class="plain block" style="width: 2em">
          </span>
        </section>
        <!-- }}} -->
 
        <section> <!-- slow/perf stuff {{{ -->
          <h2> Slow inputs?</h2>

          Just add more workers!

          <pre class="bigger"><code>input {
  amqp {
    # Use 12 threads to read from amqp
    threads => 12
    ...
  }
}</code></pre>
        </section>

        <section>
          <h2> Slow filters? </h2>

          Just add more workers!

          <pre class="bigger"><code># Run 8 filter workers (default=1)
% logstash agent -w 8 -f logstash.conf</code></pre>
        </section>

        <section>
          <h2> Scale Transport: How </h2>

          <ul>
            <li> Multiple readers
            <li> Each output knows about all readers
          </ul>
        </section>

        <section>
          <h2> Scale Transport (redis) </h2>
          <pre class="bigger"><code>input {
  redis { host => "redis1" ... }
  redis { host => "redis2" ... }
  redis { host => "redis3" ... }
}</code></pre>
        </section>

        <section>
          <h2> Scale Transport (redis) </h2>
          <pre class="bigger"><code>output {
  redis {
    # One is chosen at random and used until 
    # failure. Then we choose again.
    host => [ "redis1", "redis2", "redis3" ]
  }
}</code></pre>
        </section> <!-- }}} -->

        <!-- {{{ java -->
        <section data-markdown>
          ## deploying logstash 

          * logstash is written in ruby
          * logstash releases are java jars
          * JRuby is awesome.
        </section>

        <section>
          <blockquote> Java is bloatware! </blockquote>
          <blockquote class="fragment"> Java is slow! </blockquote>
          <blockquote class="fragment"> We can't use java because ... <span class="fragment">computers!</span> </blockquote>
          <div class="fragment">
            <img src="images/1983_delorean_dmc-12-pic-38289.jpeg" style="width: 60%;">
            <a href="http://www.cargurus.com/Cars/1983-Delorean-DMC-12-Pictures-c12522">[image from cargurus.com]</a>
            <p style="position:absolute; padding: 0.5em; top: 8em; left: 9em; background-color:rgba(0,0,0,0.7)">GO BACK TO 1997!</p>
          </div>
        </section>

        <section>
          <h2> JVM: Bad Defaults </h2>

          <ul>
            <li> IcedTea JVM: default max heap is 25% of physical memory
            <li> Try `java -Xmx100m` and tweak as necessary.
            <li> Default GC will not free memory back to the host system.
          </ul>
        </section> 

        <section data-markdown>
          ## Alternate shippers 

          * beaver
          * woodchuck
          * awesant
          * lumberjack
          * syslog-shipper
          * remote_syslog
          * Message::Passing
          * nxlog
          * rsyslog
          * syslog-ng
        </section> 
        <!-- }}} -->

        <!-- monitoring/debugging {{{ -->
        <section data-markdown>
          # Monitoring and Debugging
        </section>

        <section>
          <h2> Tracing events </h2>

          <pre class="bigger"><code>input {
  redis {
    # Add our hostname to every event 
    # in the field "logstash"
    add_field => [ "logstash", 
        "myhostname.example.com" ]
  }
}
</code></pre>
        </section>

        <section data-markdown>
          ## Grok

          grokdebug.herokuapp.com
        </section>

        <section data-markdown>
          <h2> Watch live </h2>

          <pre style="font-size: 90%"><code>output {
  <span class="fragment"># Connect with a websocket client
  websocket { ... }</span>
  <span class="fragment"># or with a tcp client (netcat!)
  tcp { mode => server ... }</span>
  <span class="fragment"># or pubsub with zeromq
  zeromq {
    topology => pubsub 
    mode => server
  }</span>
}</code></pre>
        </section>

        <section data-markdown>
          # Measure 
        </section>

        <section>
          <h2> metrics filter</h2>

          <pre class="bigger"><code>filter {
  metrics {
    # Counts events. Emits rates, etc.
    meter => "events"
    add_tag => "throughput"
  }
}</code></pre>
        </section>

        <section>
          <h2> statsd output</h2>

          <pre class="bigger"><code>output {
  statsd {
    # Count events using a statsd server.
    increment => "events"
  }
}</code></pre>
        </section>

        <section data-markdown>
          ## Debug
        </section>

        <section>
          <h2> top -Hp logstashpid </h2>

          <pre><code>
  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                
27641 logstash  20   0 10.2g 287m  17m S   24  1.8   6:27.88 <span class="left-border highlight">|worker.1                 </span>
27643 logstash  20   0 10.2g 287m  17m S   24  1.8   6:28.57 <span class="left-border highlight">|worker.2                 </span>
27640 logstash  20   0 10.2g 287m  17m S   24  1.8   6:27.11 <span class="left-border highlight">|worker.0                 </span>
27842 logstash  20   0 10.2g 287m  17m S   17  1.8   0:58.31 <span class="left-border highlight">&lt;lumberjack            </span>
27647 logstash  20   0 10.2g 287m  17m S   17  1.8   4:51.72 <span class="left-border highlight">&gt;elasticsearch_        </span>
27861 logstash  20   0 10.2g 287m  17m S   11  1.8   0:28.36 <span class="left-border highlight">&lt;lumberjack            </span>
27648 logstash  20   0 10.2g 287m  17m S   10  1.8   2:42.59 <span class="left-border highlight">&gt;websocket             </span>
27655 logstash  20   0 10.2g 287m  17m S   10  1.8   3:52.39 <span class="left-border highlight">&lt;lumberjack            </span>
27711 logstash  20   0 10.2g 287m  17m S   10  1.8   1:48.34 <span class="left-border highlight">&lt;lumberjack            </span>
27706 logstash  20   0 10.2g 287m  17m S    4  1.8   0:43.54 <span class="left-border highlight">&lt;lumberjack            </span>
          </code></pre>
        </section>

        <section data-markdown>
          ### visualvm, jstack, etc

          It's the jvm, so you get all the awesome jvm inspection/debug tools.

        </section><!-- }}} -->

        <!-- elasticsearch {{{ -->
        <section data-markdown>
          # ElasticSearch

        </section>

        <section data-markdown>
          ## Multiple logstash indexers

          * Many logstash agents can write to ES simultaneously
        </section>

        <section data-markdown>
          ## Cluster Metrics

              % curl -s http://elasticsearch-server:9200/_cluster/health?pretty
              {
                "cluster_name" : "elasticsearch",
                "status" : "yellow",
                "timed_out" : false,
                "number_of_nodes" : 2,
                "number_of_data_nodes" : 1,
                "active_primary_shards" : 95,
                "active_shards" : 95,
                "relocating_shards" : 0,
                "initializing_shards" : 0,
                "unassigned_shards" : 95
              }
        </section>

        <section>
          <h2> Index Metrics </h2>

          <pre><code>% curl -s http://elasticsearch-server:9200/_status?pretty
...
  "indices" : {
    "logstash-2013.03.12" : {
      "index" : {
        "primary_size" : "14.4mb",
        "primary_size_in_bytes" : 15112895,
        "size" : "14.4mb",
        "size_in_bytes" : 15112895
      },
...</code></pre>
        </section>

        <section>
          <h2> Process Metrics </h2>

          <pre><code>% curl -s 'elasticsearch:9200/_nodes/jvm/stats?pretty' 
...
% curl -s 'elasticsearch:9200/_nodes/os/stats?pretty' 
...
% curl -s 'elasticsearch:9200/_nodes/indices/stats?pretty' 
...
% curl -s 'elasticsearch:9200/_nodes/fs/stats?pretty' 
...</code></pre>
        </section>

        <section data-markdown>
          ## Index Templates

          * Apply configurations to new indexes
          * Pattern-based
          * like `logstash-*`
        </section>

        <section data-markdown>
          ## Compression

          Enable it. 55% storage improvement.

              index.store.compress.stored: true
              index.store.compress.tv: true
        </section>

        <section data-markdown>
          ## Curation

          * delete daily indexes older than X days
          * LOGSTASH-211 has a script to do this.
        </section> <!-- }}} -->

        <!-- closing (2 slides) {{{ -->
        <section>
          <img src="images/logstashbook.png" class="full plain">
        </section>

        <section data-markdown>
          ## Tomorrow:

          ## workshop @ 10:15

          ---

          ## Hackathon: I want your help!
        </section>
        <!-- }}} -->
      </div>
      </div>
    </div>

    <!-- scripts {{{ -->
    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.min.js"></script>

    <script>

      // Full list of configuration options available here:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: false,

        theme: Reveal.getQueryHash().theme || "night-jls", // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'fade', // default/cube/page/concave/zoom/linear/fade/none

        // Optional libraries used to extend on reveal.js
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/showdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
          { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
          // { src: 'plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
        ]
      });

    </script>

    <!-- }}} -->
  </body>
</html>
